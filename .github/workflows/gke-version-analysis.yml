name: GKE Version Change Analysis

on:
  pull_request:
    paths:
      - 'gke-version.yaml'
    types: [opened, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  detect-version-change:
    runs-on: ubuntu-latest
    outputs:
      old_controlplane_version: ${{ steps.detect.outputs.old_controlplane_version }}
      new_controlplane_version: ${{ steps.detect.outputs.new_controlplane_version }}
      old_nodes_version: ${{ steps.detect.outputs.old_nodes_version }}
      new_nodes_version: ${{ steps.detect.outputs.new_nodes_version }}
      has_changes: ${{ steps.detect.outputs.has_changes }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect version changes
        id: detect
        run: |
          # Get the base branch
          git fetch origin ${{ github.base_ref }}

          # Extract versions from current branch
          NEW_CP=$(grep -A 1 "controlplane:" gke-version.yaml | grep "version:" | awk '{print $2}')
          NEW_NODES=$(grep -A 1 "nodes:" gke-version.yaml | grep "version:" | awk '{print $2}')

          # Extract versions from base branch
          git checkout origin/${{ github.base_ref }} -- gke-version.yaml 2>/dev/null || true

          if [ -f gke-version.yaml ]; then
            OLD_CP=$(grep -A 1 "controlplane:" gke-version.yaml | grep "version:" | awk '{print $2}')
            OLD_NODES=$(grep -A 1 "nodes:" gke-version.yaml | grep "version:" | awk '{print $2}')
          else
            OLD_CP="none"
            OLD_NODES="none"
          fi

          # Restore current branch version
          git checkout HEAD -- gke-version.yaml

          echo "old_controlplane_version=$OLD_CP" >> $GITHUB_OUTPUT
          echo "new_controlplane_version=$NEW_CP" >> $GITHUB_OUTPUT
          echo "old_nodes_version=$OLD_NODES" >> $GITHUB_OUTPUT
          echo "new_nodes_version=$NEW_NODES" >> $GITHUB_OUTPUT

          if [ "$OLD_CP" != "$NEW_CP" ] || [ "$OLD_NODES" != "$NEW_NODES" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

          echo "Version changes detected:"
          echo "Controlplane: $OLD_CP -> $NEW_CP"
          echo "Nodes: $OLD_NODES -> $NEW_NODES"

  # fetch-release-notes:
  #   needs: detect-version-change
  #   if: needs.detect-version-change.outputs.has_changes == 'true'
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Extract Kubernetes versions
  #       id: k8s_versions
  #       run: |
  #         OLD_VERSION="${{ needs.detect-version-change.outputs.old_controlplane_version }}"
  #         NEW_VERSION="${{ needs.detect-version-change.outputs.new_controlplane_version }}"

  #         # Extract K8s version (e.g., 1.32.8-gke.1134000 -> 1.32)
  #         OLD_K8S=$(echo $OLD_VERSION | cut -d. -f1,2)
  #         NEW_K8S=$(echo $NEW_VERSION | cut -d. -f1,2)

  #         echo "old_k8s=$OLD_K8S" >> $GITHUB_OUTPUT
  #         echo "new_k8s=$NEW_K8S" >> $GITHUB_OUTPUT

  #     - name: Download Kubernetes Release Notes
  #       run: |
  #         OLD_K8S="${{ steps.k8s_versions.outputs.old_k8s }}"
  #         NEW_K8S="${{ steps.k8s_versions.outputs.new_k8s }}"

  #         mkdir -p release-notes

  #         # Download new version release notes
  #         echo "Fetching Kubernetes $NEW_K8S release notes..."
  #         curl -sL "https://raw.githubusercontent.com/kubernetes/kubernetes/master/CHANGELOG/CHANGELOG-${NEW_K8S}.md" \
  #           -o release-notes/k8s-${NEW_K8S}.md || echo "Failed to fetch K8s $NEW_K8S"

  #         # Download old version if different
  #         if [ "$OLD_K8S" != "$NEW_K8S" ] && [ "$OLD_K8S" != "none" ]; then
  #           echo "Fetching Kubernetes $OLD_K8S release notes..."
  #           curl -sL "https://raw.githubusercontent.com/kubernetes/kubernetes/master/CHANGELOG/CHANGELOG-${OLD_K8S}.md" \
  #             -o release-notes/k8s-${OLD_K8S}.md || echo "Failed to fetch K8s $OLD_K8S"
  #         fi

  #     - name: Fetch GKE Release Notes
  #       run: |
  #         echo "Fetching GKE release notes..."
  #         curl -sL "https://cloud.google.com/kubernetes-engine/docs/release-notes" \
  #           -o release-notes/gke-release-notes.html || echo "Failed to fetch GKE release notes"

  #     - name: Create context file for Claude
  #       run: |
  #         cat > release-notes/analysis-context.md << 'EOF'
  #         # GKE Version Upgrade Context

  #         ## Version Changes
  #         - **Old Controlplane Version**: ${{ needs.detect-version-change.outputs.old_controlplane_version }}
  #         - **New Controlplane Version**: ${{ needs.detect-version-change.outputs.new_controlplane_version }}
  #         - **Old Nodes Version**: ${{ needs.detect-version-change.outputs.old_nodes_version }}
  #         - **New Nodes Version**: ${{ needs.detect-version-change.outputs.new_nodes_version }}

  #         ## Project Information
  #         - **Cluster Name**: test-tokyo-cluster
  #         - **Environment**: dev
  #         - **Location**: asia-northeast1
  #         - **Platform**: Google Kubernetes Engine (GKE)

  #         ## Analysis Request

  #         ä¸Šè¨˜ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›´ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®è¦³ç‚¹ã§è©³ç´°ãªåˆ†æã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š

  #         ### 1. ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›´ã‚µãƒãƒªãƒ¼
  #         - ãƒ¡ã‚¸ãƒ£ãƒ¼/ãƒã‚¤ãƒŠãƒ¼/ãƒ‘ãƒƒãƒãƒ¬ãƒ™ãƒ«ã®å¤‰æ›´ã‚’æ˜ç¢ºã«
  #         - ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ‘ã‚¹ã®å¦¥å½“æ€§

  #         ### 2. ğŸš¨ Breaking Changesï¼ˆç ´å£Šçš„å¤‰æ›´ï¼‰
  #         - APIå¤‰æ›´ï¼ˆå‰Šé™¤ã€å‹•ä½œå¤‰æ›´ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤å¤‰æ›´ï¼‰
  #         - äº’æ›æ€§ã«å½±éŸ¿ã™ã‚‹å¤‰æ›´
  #         - å¿…é ˆã®å¯¾å¿œäº‹é …

  #         ### 3. âš ï¸ Deprecationsï¼ˆéæ¨å¥¨åŒ–ï¼‰
  #         - éæ¨å¥¨ã¨ãªã£ãŸAPI/æ©Ÿèƒ½
  #         - å‰Šé™¤äºˆå®šæ™‚æœŸ
  #         - ä»£æ›¿æ‰‹æ®µ

  #         ### 4. ğŸ”’ Security Updatesï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
  #         - CVEä¿®æ­£
  #         - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒ
  #         - è„†å¼±æ€§å¯¾å¿œ

  #         ### 5. âœ¨ New Features & Improvements
  #         - æ–°æ©Ÿèƒ½
  #         - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„
  #         - å®‰å®šæ€§å‘ä¸Š

  #         ### 6. ğŸ¯ Impact on This Project
  #         ã“ã®GKEã‚¯ãƒ©ã‚¹ã‚¿ã¸ã®å…·ä½“çš„ãªå½±éŸ¿ã‚’åˆ†æã—ã¦ãã ã•ã„ï¼š
  #         - å½±éŸ¿åº¦ï¼ˆCritical/High/Medium/Lowï¼‰
  #         - å¿…è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  #         - ãƒ†ã‚¹ãƒˆé …ç›®
  #         - ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»ã®å¿…è¦æ€§

  #         ### 7. ğŸ“‹ Action Items
  #         ä»¥ä¸‹ã®å½¢å¼ã§ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
  #         - [ ] å®Ÿæ–½ã™ã¹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  #         - [ ] æ¤œè¨¼é …ç›®
  #         - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

  #         ### 8. ğŸ“š References
  #         é–¢é€£ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸ã®ãƒªãƒ³ã‚¯

  #         ## Output Format

  #         Markdownå½¢å¼ã§ã€ä¸Šè¨˜ã®æ§‹é€ ã«å¾“ã£ã¦åˆ†æçµæœã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
  #         æŠ€è¡“çš„ã«æ­£ç¢ºã§ã€actionableãªæƒ…å ±ã‚’æä¾›ã™ã‚‹ã“ã¨ã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚
  #         EOF

  #     - name: Upload release notes artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: release-notes
  #         path: release-notes/
  #         retention-days: 30

  # analyze-with-claude:
  #   needs: [detect-version-change, fetch-release-notes]
  #   if: needs.detect-version-change.outputs.has_changes == 'true'
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Download release notes
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: release-notes
  #         path: release-notes/

  #     - name: Create PR comment with Claude mention
  #       uses: actions/github-script@v7
  #       with:
  #         github-token: ${{ secrets.GITHUB_TOKEN }}
  #         script: |
  #           const fs = require('fs');

  #           // Read context file
  #           const context = fs.readFileSync('release-notes/analysis-context.md', 'utf8');

  #           // Read release notes if available
  #           let releaseNotes = '';
  #           const files = fs.readdirSync('release-notes/');
  #           for (const file of files) {
  #             if (file.startsWith('k8s-')) {
  #               const content = fs.readFileSync(`release-notes/${file}`, 'utf8');
  #               // Limit to first 10000 characters to avoid too long comment
  #               releaseNotes += `\n\n## ${file}\n${content.substring(0, 10000)}...\n`;
  #             }
  #           }

  #           const commentBody = `## ğŸ”„ GKE Version Change Detected

  #           ${context}

  #           ---

  #           @claude ä¸Šè¨˜ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’åˆ†æã—ã¦ã€ã“ã®GKEãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã®è©³ç´°ãªå½±éŸ¿åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

  #           <details>
  #           <summary>ğŸ“„ Kubernetes Release Notes (æŠœç²‹)</summary>

  #           ${releaseNotes}

  #           </details>

  #           **åˆ†æã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€Claude Code GitHub App ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚**
  #           `;

  #           await github.rest.issues.createComment({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             issue_number: context.issue.number,
  #             body: commentBody
  #           });

  # validate-version:
  #   needs: detect-version-change
  #   if: needs.detect-version-change.outputs.has_changes == 'true'
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Setup gcloud CLI
  #       uses: google-github-actions/setup-gcloud@v2

  #     - name: Validate GKE version availability
  #       run: |
  #         chmod +x ./check-gke-version.sh

  #         if ./check-gke-version.sh; then
  #           echo "âœ… All versions are valid and available in GKE"
  #         else
  #           echo "âŒ Version validation failed"
  #           echo "Please check the GKE release notes and update to a valid version"
  #           exit 1
  #         fi
