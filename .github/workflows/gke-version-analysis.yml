name: GKE Version Change Analysis

on:
  # pull_request:
  #   paths:
  #     - 'gke-version.yaml'
  #   types: [opened, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  detect-version-change:
    runs-on: ubuntu-latest
    outputs:
      old_controlplane_version: ${{ steps.detect.outputs.old_controlplane_version }}
      new_controlplane_version: ${{ steps.detect.outputs.new_controlplane_version }}
      old_nodes_version: ${{ steps.detect.outputs.old_nodes_version }}
      new_nodes_version: ${{ steps.detect.outputs.new_nodes_version }}
      has_changes: ${{ steps.detect.outputs.has_changes }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup yq
        uses: mikefarah/yq@master

      - name: Detect version changes
        id: detect
        run: |
          # Get the base branch
          git fetch origin ${{ github.base_ref }}

          # Extract versions from current branch using yq
          NEW_CP=$(yq eval '.controlplane.version' gke-version.yaml)
          NEW_NODES=$(yq eval '.nodes.version' gke-version.yaml)

          # Extract versions from base branch
          git checkout origin/${{ github.base_ref }} -- gke-version.yaml 2>/dev/null || true

          if [ -f gke-version.yaml ]; then
            OLD_CP=$(yq eval '.controlplane.version' gke-version.yaml)
            OLD_NODES=$(yq eval '.nodes.version' gke-version.yaml)
          else
            OLD_CP="none"
            OLD_NODES="none"
          fi

          # Restore current branch version
          git checkout HEAD -- gke-version.yaml

          echo "old_controlplane_version=$OLD_CP" >> $GITHUB_OUTPUT
          echo "new_controlplane_version=$NEW_CP" >> $GITHUB_OUTPUT
          echo "old_nodes_version=$OLD_NODES" >> $GITHUB_OUTPUT
          echo "new_nodes_version=$NEW_NODES" >> $GITHUB_OUTPUT

          if [ "$OLD_CP" != "$NEW_CP" ] || [ "$OLD_NODES" != "$NEW_NODES" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

          echo "Version changes detected:"
          echo "Controlplane: $OLD_CP -> $NEW_CP"
          echo "Nodes: $OLD_NODES -> $NEW_NODES"

  fetch-release-notes:
    needs: detect-version-change
    if: needs.detect-version-change.outputs.has_changes == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract Kubernetes versions
        id: k8s_versions
        run: |
          OLD_VERSION="${{ needs.detect-version-change.outputs.old_controlplane_version }}"
          NEW_VERSION="${{ needs.detect-version-change.outputs.new_controlplane_version }}"

          # Extract K8s version (e.g., 1.32.8-gke.1134000 -> 1.32)
          OLD_K8S=$(echo $OLD_VERSION | cut -d. -f1,2)
          NEW_K8S=$(echo $NEW_VERSION | cut -d. -f1,2)

          echo "old_k8s=$OLD_K8S" >> $GITHUB_OUTPUT
          echo "new_k8s=$NEW_K8S" >> $GITHUB_OUTPUT

      - name: Download Kubernetes Release Notes
        run: |
          OLD_K8S="${{ steps.k8s_versions.outputs.old_k8s }}"
          NEW_K8S="${{ steps.k8s_versions.outputs.new_k8s }}"

          mkdir -p release-notes

          # Download new version release notes
          echo "Fetching Kubernetes $NEW_K8S release notes..."
          curl -sL "https://raw.githubusercontent.com/kubernetes/kubernetes/master/CHANGELOG/CHANGELOG-${NEW_K8S}.md" \
            -o release-notes/k8s-${NEW_K8S}.md || echo "Failed to fetch K8s $NEW_K8S"

      - name: Upload release notes artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release-notes/
          retention-days: 30

  check-deprecated-apis:
    needs: detect-version-change
    if: needs.detect-version-change.outputs.has_changes == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract target Kubernetes version
        id: target_version
        run: |
          NEW_VERSION="${{ needs.detect-version-change.outputs.new_controlplane_version }}"
          # Extract K8s version (e.g., 1.32.8-gke.1134000 -> v1.32)
          TARGET_K8S="v$(echo $NEW_VERSION | cut -d. -f1,2)"
          echo "target_k8s=$TARGET_K8S" >> $GITHUB_OUTPUT
          echo "Target Kubernetes version: $TARGET_K8S"

      - name: Install Pluto
        run: |
          VERSION=$(curl -s https://api.github.com/repos/FairwindsOps/pluto/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
          curl -Lo pluto.tar.gz "https://github.com/FairwindsOps/pluto/releases/download/v${VERSION}/pluto_${VERSION}_linux_amd64.tar.gz"
          tar xzf pluto.tar.gz
          chmod +x pluto
          sudo mv pluto /usr/local/bin/
          rm pluto.tar.gz
          echo "‚úÖ Pluto version $(pluto version) installed"

      - name: Scan for deprecated APIs
        id: pluto_scan
        run: |
          echo "Scanning repository for deprecated Kubernetes APIs..."
          echo ""

          # Run Pluto and save output
          pluto detect-files -d . --target-versions k8s=${{ steps.target_version.outputs.target_k8s }} -o wide > pluto-report.txt || true

          # Display results
          cat pluto-report.txt

          # Check if deprecated APIs were found
          if grep -q "API VERSIONS" pluto-report.txt; then
            echo "deprecated_found=true" >> $GITHUB_OUTPUT
          else
            echo "deprecated_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pluto report artifact
        run: |
          cat > pluto-report.md << 'EOF'
          # Deprecated API Detection Report

          Target Kubernetes Version: `${{ steps.target_version.outputs.target_k8s }}`

          ## Scan Results

          ```
          EOF
          cat pluto-report.txt >> pluto-report.md
          echo '```' >> pluto-report.md

      - name: Upload Pluto report
        uses: actions/upload-artifact@v4
        with:
          name: pluto-report
          path: pluto-report.md
          retention-days: 30

      - name: Post Pluto report to PR
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          DEPRECATED_FOUND: ${{ steps.pluto_scan.outputs.deprecated_found }}
        run: |
          # Create comment body
          if [ "$DEPRECATED_FOUND" = "true" ]; then
            cat > pluto-comment.md << 'COMMENT_EOF'
          ## ‚ö†Ô∏è Deprecated API Detection Report

          **Target Version**: `${{ steps.target_version.outputs.target_k8s }}`

          Pluto detected deprecated Kubernetes APIs in your manifests:

          ```
          COMMENT_EOF
            cat pluto-report.txt >> pluto-comment.md
            cat >> pluto-comment.md << 'COMMENT_EOF'
          ```

          **Action Required**: Please update the affected manifests before upgrading.

          ---

          <sub>üîç Scanned by [Pluto](https://github.com/FairwindsOps/pluto) | [Download Full Report](https://github.com/${REPO}/actions/runs/${{ github.run_id }})</sub>
          COMMENT_EOF
          else
            cat > pluto-comment.md << 'COMMENT_EOF'
          ## ‚úÖ Deprecated API Detection Report

          **Target Version**: `${{ steps.target_version.outputs.target_k8s }}`

          No deprecated Kubernetes APIs detected in your manifests.

          ---

          <sub>üîç Scanned by [Pluto](https://github.com/FairwindsOps/pluto) | [Download Full Report](https://github.com/${REPO}/actions/runs/${{ github.run_id }})</sub>
          COMMENT_EOF
          fi

      - name: Post Pluto comment
        uses: ./.github/actions/post-pr-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pr-number: ${{ github.event.pull_request.number }}
          comment-file: pluto-comment.md
          identifier: 'Deprecated API Detection Report'

  analyze-with-claude:
    needs: [detect-version-change, fetch-release-notes]
    if: needs.detect-version-change.outputs.has_changes == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: release-notes/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Create analysis prompt
        run: |
          cat > analysis-prompt.txt << 'PROMPT_EOF'
          „ÅÇ„Å™„Åü„ÅØKubernetes„Å®GKE„ÅÆÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇ

          release-notes/ „Éá„Ç£„É¨„ÇØ„Éà„É™„Å´„ÅØ‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´„Åå„ÅÇ„Çä„Åæ„ÅôÔºö
          - analysis-context.md: „Éê„Éº„Ç∏„Éß„É≥Â§âÊõ¥„ÅÆ„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÊÉÖÂ†±
          - k8s-*.md: Kubernetes„ÅÆÂÖ¨Âºè„É™„É™„Éº„Çπ„Éé„Éº„Éà

          „Åì„Çå„Çâ„ÅÆ„Éï„Ç°„Ç§„É´„Å®manifests„ÇíË™≠„ÅøËæº„Çì„ÅßÂàÜÊûê„Åó„ÄÅ„Éï„Ç°„Ç§„É´„Å´„ÅØ„Åæ„Å®„ÇÅ„Åö„ÄÅ
          ‰ª•‰∏ã„ÅÆÊßãÈÄ†„ÇíÂÆà„Å£„Å¶„É¨„Éù„Éº„Éà„ÇíÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          **üö® ÂøÖÈ†àË¶Å‰ª∂ - „É™„É™„Éº„Çπ„Éé„Éº„Éà„Å∏„ÅÆÂèÇÁÖß„É™„É≥„ÇØ**:

          „Åô„Åπ„Å¶„ÅÆÊÉÖÂ†±„Å´„ÅØÂøÖ„ÅöÂèÇÁÖßÂÖÉ„ÅÆ„É™„É™„Éº„Çπ„Éé„Éº„Éà„É™„É≥„ÇØ„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Åì„Çå„ÅØÂøÖÈ†àË¶Å‰ª∂„Åß„Åô„ÄÇ

          „É™„É≥„ÇØÂΩ¢Âºè„ÅÆ‰æãÔºö
          - „Éê„Éº„Ç∏„Éß„É≥ÂÖ®‰Ωì: `[Kubernetes 1.33 CHANGELOG](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.33.md)`
          - ÁâπÂÆö„ÅÆ„Éê„Éº„Ç∏„Éß„É≥: `[v1.33.5](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.33.md#v1335)`
          - „Çª„ÇØ„Ç∑„Éß„É≥: `[Urgent Upgrade Notes](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.33.md#urgent-upgrade-notes)`
          - ÂÖ∑‰ΩìÁöÑ„Å™PR/Issue: `[#12345](https://github.com/kubernetes/kubernetes/pull/12345)`

          ÂêÑÈ†ÖÁõÆ„Å´„Äå**ÂèÇÁÖß**:„Äç„Éï„Ç£„Éº„É´„Éâ„ÇíÂøÖ„ÅöËøΩÂä†„Åó„ÄÅ„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„É™„É≥„ÇØ„ÇíÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          ---

          # GKE Version Upgrade Analysis

          ## üìä Version Change Summary

          „Éê„Éº„Ç∏„Éß„É≥Â§âÊõ¥„ÅÆÊ¶ÇË¶Å„ÇíÂõûÁ≠îÔºö
          - Â§âÊõ¥„É¨„Éô„É´: Major/Minor/Patch
          - Â§âÊõ¥ÁØÑÂõ≤: Kubernetes 1.X ‚Üí 1.Y
          - „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Éë„Çπ: Áõ¥Êé•„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÂèØËÉΩ or ÊÆµÈöéÁöÑ„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÂøÖË¶Å

          **ÂèÇÁÖß**: [Kubernetes 1.XX CHANGELOG](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.XX.md) „Åä„Çà„Å≥ [v1.XX.X Release](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.XX.md#v1XXX)

          ---

          ## üö® URGENT UPGRADE NOTES

          **ÊúÄÂÑ™ÂÖà‰∫ãÈ†Ö**: „É™„É™„Éº„Çπ„Éé„Éº„Éà„ÅÆ "Urgent Upgrade Notes" „Çª„ÇØ„Ç∑„Éß„É≥„ÇíÁ¢∫Ë™ç„Åó„ÄÅ‰ª•‰∏ã„ÇíÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

          - Âç≥Â∫ß„Å´ÂØæÂøú„ÅåÂøÖË¶Å„Å™Â§âÊõ¥
          - „ÇØ„É©„Çπ„Çø„ÅÆÂãï‰Ωú„Å´ÂΩ±Èüø„Åô„ÇãÈáçÂ§ß„Å™Â§âÊõ¥
          - „Éá„Éº„ÇøÊêçÂ§±„ÇÑÂèØÁî®ÊÄß„Å´ÂΩ±Èüø„Åô„ÇãÂïèÈ°å

          **ÂõûÁ≠îÂΩ¢Âºè**ÔºàÂøÖ„Åö‰ª•‰∏ã„ÅÆÂΩ¢Âºè„Å´Âæì„Å£„Å¶„Åè„Å†„Åï„ÅÑÔºâ:

          ### [„Çø„Ç§„Éà„É´]
          - **ÂΩ±Èüø**: „Å©„ÅÆ„Çà„ÅÜ„Å™ÂΩ±Èüø„Åå„ÅÇ„Çã„Åã
          - **ÂØæÂøú**: ‰Ωï„Çí„Åô„Åπ„Åç„Åã
          - **ÊúüÈôê**: „ÅÑ„Å§„Åæ„Åß„Å´ÂØæÂøú„Åô„Åπ„Åç„Åã
          - **ÂèÇÁÖß**: [Urgent Upgrade Notes - ÂÖ∑‰ΩìÁöÑ„Å™È†ÖÁõÆÂêç](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.XX.md#urgent-upgrade-notes)

          „ÇÇ„ÅóË©≤ÂΩìÈ†ÖÁõÆ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´ÂõûÁ≠î:
          ```
          Ë©≤ÂΩì„Å™„Åó

          **ÂèÇÁÖß**: [Kubernetes 1.XX Urgent Upgrade Notes](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.XX.md#urgent-upgrade-notes) - „Çª„ÇØ„Ç∑„Éß„É≥„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åó„Åü„Åå„ÄÅË©≤ÂΩìÈ†ÖÁõÆ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ
          ```

          ---

          ## üîí Security Updates

          „Çª„Ç≠„É•„É™„ÉÜ„Ç£Èñ¢ÈÄ£„ÅÆÂ§âÊõ¥„ÇíÂøÖ„Åö„É™„É≥„ÇØ‰ªò„Åç„ÅßÂõûÁ≠îÔºö

          ### CVE‰øÆÊ≠£

          ÂêÑCVE„Å´„Å§„ÅÑ„Å¶‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅßÂõûÁ≠îÔºö

          #### CVE-YYYY-XXXXX: [„Çø„Ç§„Éà„É´]
          - **Ê¶ÇË¶Å**: CVE„ÅÆË™¨Êòé
          - **ÂΩ±Èüø**: „Å©„ÅÆ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà/„Éê„Éº„Ç∏„Éß„É≥„Å´ÂΩ±Èüø„Åô„Çã„Åã
          - **‰øÆÊ≠£ÂÜÖÂÆπ**: ‰Ωï„Åå‰øÆÊ≠£„Åï„Çå„Åü„Åã
          - **Êé®Â•®„Ç¢„ÇØ„Ç∑„Éß„É≥**: „É¶„Éº„Ç∂„Éº„Åå„Åô„Åπ„Åç„Åì„Å®
          - **ÂèÇÁÖß**: [CVE-YYYY-XXXXX](CVE„Å∏„ÅÆ„É™„É≥„ÇØ) | [Release Notes](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.XX.md#changelog-since-vXXX)

          ### „Çª„Ç≠„É•„É™„ÉÜ„Ç£Âº∑Âåñ

          ÂêÑ„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ê©üËÉΩ„Å´„Å§„ÅÑ„Å¶Ôºö

          #### [Ê©üËÉΩÂêç]
          - **ÂÜÖÂÆπ**: ËøΩÂä†„Åï„Çå„Åü„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ê©üËÉΩ„Åæ„Åü„ÅØ„Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö„ÅÆÂ§âÊõ¥
          - **ÂΩ±Èüø**: Êó¢Â≠ò„ÅÆË®≠ÂÆö„Å∏„ÅÆÂΩ±Èüø
          - **Êé®Â•®Ë®≠ÂÆö**: Êé®Â•®„Åï„Çå„ÇãË®≠ÂÆö
          - **ÂèÇÁÖß**: [Ë©≤ÂΩì„Çª„ÇØ„Ç∑„Éß„É≥](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.XX.md#„Çª„ÇØ„Ç∑„Éß„É≥Âêç)

          ---

          ## üí• Breaking Changes

          Á†¥Â£äÁöÑÂ§âÊõ¥„Çí‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅßÂõûÁ≠îÔºö

          ### [Â§âÊõ¥ÂÜÖÂÆπ]

          - **Â§âÊõ¥ÁÇπ**: ‰Ωï„ÅåÂ§â„Çè„Å£„Åü„Åã
          - **ÂΩ±ÈüøÁØÑÂõ≤**: „Å©„ÅÆ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Å´ÂΩ±Èüø„Åô„Çã„Åã
          - **ÁßªË°åÊñπÊ≥ï**: „Å©„ÅÜÂØæÂøú„Åô„Åπ„ÅçÔøΩÔøΩ
          - **ÂΩ±ÈüøÂ∫¶**: Critical/High/Medium/Low
          - **ÂèÇÁÖß**: [„É™„É™„Éº„Çπ„Éé„Éº„Éà„Å∏„ÅÆ„É™„É≥„ÇØ](URL)

          ---

          ## ‚ú® New Features & Improvements

          Êñ∞Ê©üËÉΩ„Å®ÊîπÂñÑÁÇπÔºö

          ### ‰∏ªË¶Å„Å™Êñ∞Ê©üËÉΩ

          - **Ê©üËÉΩÂêç**: Ë™¨Êòé„Å®Ê¥ªÁî®ÊñπÊ≥ï
            - **ÂèÇÁÖß**: [„É™„É™„Éº„Çπ„Éé„Éº„Éà„Å∏„ÅÆ„É™„É≥„ÇØ](URL)

          ### „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊîπÂñÑ

          - ÊîπÂñÑÂÜÖÂÆπ„Å®ÊúüÂæÖ„Åï„Çå„ÇãÂäπÊûú
            - **ÂèÇÁÖß**: [„É™„É™„Éº„Çπ„Éé„Éº„Éà„Å∏„ÅÆ„É™„É≥„ÇØ](URL)

          ### ÂÆâÂÆöÊÄßÂêë‰∏ä

          - ‰øÆÊ≠£„Åï„Çå„Åü„Éê„Ç∞„ÇÑÊîπÂñÑ„Åï„Çå„ÅüÂãï‰Ωú
            - **ÂèÇÁÖß**: [„É™„É™„Éº„Çπ„Éé„Éº„Éà„Å∏„ÅÆ„É™„É≥„ÇØ](URL)

          ---

          ## üì¶ Manifest Impact Analysis

          **ÈáçË¶Å**: „É™„Éù„Ç∏„Éà„É™ÂÜÖ„ÅÆ„Åô„Åπ„Å¶„ÅÆKubernetes„Éû„Éã„Éï„Çß„Çπ„Éà„Éï„Ç°„Ç§„É´„ÇíÁ¢∫Ë™ç„Åó„ÄÅ„Éê„Éº„Ç∏„Éß„É≥„Ç¢„ÉÉ„Éó„ÅÆÂΩ±Èüø„ÇíÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          ### ÂΩ±Èüø„ÇíÂèó„Åë„Çã„Éû„Éã„Éï„Çß„Çπ„Éà

          **ÂΩ±Èüø„Åå„ÅÇ„Çã„Éû„Éã„Éï„Çß„Çπ„Éà„ÅÆ„ÅøÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ**„ÄÇÂΩ±Èüø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄåÂΩ±Èüø„Å™„Åó„Äç„Å®„Å†„ÅëÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          ÂΩ±Èüø„Åå„ÅÇ„Çã„Éû„Éã„Éï„Çß„Çπ„Éà„Å´„Å§„ÅÑ„Å¶Ôºö

          #### [„Éû„Éã„Éï„Çß„Çπ„Éà„Éï„Ç°„Ç§„É´Âêç]

          - **‰ΩøÁî®„Åó„Å¶„ÅÑ„ÇãAPI„Éê„Éº„Ç∏„Éß„É≥**: ‰æã) apps/v1, batch/v1
          - **ÂΩ±ÈüøÂÜÖÂÆπ**: ÈùûÊé®Â•®API„ÄÅÂãï‰ΩúÂ§âÊõ¥„ÄÅBreaking Change„Å™„Å©
          - **ÂøÖË¶Å„Å™„Ç¢„ÇØ„Ç∑„Éß„É≥**: ‰øÆÊ≠£„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØÂÖ∑‰ΩìÁöÑ„Å´ÂõûÁ≠î
          - **ÂÑ™ÂÖàÂ∫¶**: Critical/High/Medium/Low
          - **ÂèÇÁÖß**: [Èñ¢ÈÄ£„Åô„Çã„É™„É™„Éº„Çπ„Éé„Éº„Éà„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„Å∏„ÅÆ„É™„É≥„ÇØ](URL)

          ### Êñ∞Ê©üËÉΩ„ÅßÊîπÂñÑ„Åß„Åç„ÇãÂèØËÉΩÊÄß

          Êñ∞Ê©üËÉΩ„ÇíÊ¥ªÁî®„Åó„Å¶„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÇÑ„Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÇíÊîπÂñÑ„Åß„Åç„Çã„Éû„Éã„Éï„Çß„Çπ„Éà„Åå„ÅÇ„Çå„Å∞ÂõûÁ≠îÔºö
          - „Éû„Éã„Éï„Çß„Çπ„Éà„Éï„Ç°„Ç§„É´Âêç
          - ÈÅ©Áî®„Åß„Åç„ÇãÊñ∞Ê©üËÉΩ
          - ÊúüÂæÖ„Åï„Çå„ÇãÂäπÊûú
          - **ÂèÇÁÖß**: [„É™„É™„Éº„Çπ„Éé„Éº„Éà„Å∏„ÅÆ„É™„É≥„ÇØ](URL)

          ---

          ## üìö References

          „Åì„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„Å´„ÄÅÂàÜÊûê„ÅßÂèÇÁÖß„Åó„Åü„Åô„Åπ„Å¶„ÅÆ„É™„É™„Éº„Çπ„Éé„Éº„Éà„ÅÆ„É™„É≥„ÇØ„Çí„Åæ„Å®„ÇÅ„Å¶ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

          - [Kubernetes X.YY.Z Release Notes](URL)
          - [Kubernetes X.YY CHANGELOG](URL)
          - „Åù„ÅÆ‰ªñÂèÇÁÖß„Åó„Åü„Éâ„Ç≠„É•„É°„É≥„Éà

          ---

          **ÂàÜÊûê„ÅÆÈáçË¶Å„Å™„Éù„Ç§„É≥„Éà**:
          1. „É™„É™„Éº„Çπ„Éé„Éº„Éà„ÅÆ‰∫ãÂÆü„Å´Âü∫„Å•„ÅÑ„Å¶ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          2. Êé®Ê∏¨„ÅØÈÅø„Åë„ÄÅ‰∏çÊòé„Å™ÁÇπ„ÅØ„ÄåË¶ÅÁ¢∫Ë™ç„Äç„Å®ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          3. Urgent Upgrade Notes „ÅØÂøÖ„ÅöÁ¢∫Ë™ç„Åó„ÄÅÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØË©≥Á¥∞„Å´ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          4. „É™„Éù„Ç∏„Éà„É™ÂÜÖ„ÅÆ„Åô„Åπ„Å¶„ÅÆ„Éû„Éã„Éï„Çß„Çπ„Éà„Éï„Ç°„Ç§„É´„ÇíÁ¢∫Ë™ç„Åó„ÄÅÂÖ∑‰ΩìÁöÑ„Å™ÂΩ±Èüø„ÇíÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          5. ÈùûÊé®Â•®API„ÅØÂÖ∑‰ΩìÁöÑ„Å™„Éï„Ç°„Ç§„É´Âêç„Å®API„Éê„Éº„Ç∏„Éß„É≥„ÇíÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          6. actionable „Å™ÊÉÖÂ†±„ÇíÊèê‰æõ„Åô„Çã„Åì„Å®„ÇíÊúÄÂÑ™ÂÖà„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          7. **„Åô„Åπ„Å¶„ÅÆÊÉÖÂ†±„Å´ÂèÇÁÖßÂÖÉ„ÅÆ„É™„É™„Éº„Çπ„Éé„Éº„Éà„É™„É≥„ÇØ„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ**ÔºàÊúÄÈáçË¶ÅÔºâ
          8. **„É™„É≥„ÇØ„Åå„Å™„ÅÑÈ†ÖÁõÆ„ÅØ‰∏çÂÆåÂÖ®„Å®„Åø„Å™„Åï„Çå„Åæ„Åô„ÄÇÂøÖ„ÅöÂêÑÈ†ÖÁõÆ„Å´ÂèÇÁÖß„É™„É≥„ÇØ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ**
          9. **ÂêÑ„Çª„ÇØ„Ç∑„Éß„É≥„ÅßÊÉÖÂ†±„ÇíÂõûÁ≠î„Åô„ÇãÈöõ„ÅØ„ÄÅ„Åù„ÅÆÊÉÖÂ†±„Åå„É™„É™„Éº„Çπ„Éé„Éº„Éà„ÅÆ„Å©„Åì„Å´ÂõûÁ≠î„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÄÅÂÖ∑‰ΩìÁöÑ„Å™URL„ÇíÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ**
          PROMPT_EOF

      - name: Run Claude analysis (headless mode)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Starting Claude Code analysis in headless mode..."
          claude -p "$(cat analysis-prompt.txt)" > analysis-report.md || {
            echo "# Analysis Failed" > analysis-report.md
            echo "Claude Code analysis failed. Please check the logs." >> analysis-report.md
            exit 1
          }

      - name: Post analysis to PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          # Create comment body
          cat > comment-body.md << 'COMMENT_EOF'
          ## üîÑ GKE Version Upgrade Analysis

          **Version Change**: `${{ needs.detect-version-change.outputs.old_controlplane_version }}` ‚Üí `${{ needs.detect-version-change.outputs.new_controlplane_version }}`

          ---

          COMMENT_EOF

          # Append analysis
          cat analysis-report.md >> comment-body.md

          # Append footer
          cat >> comment-body.md << COMMENT_EOF

          ---

          <sub>ü§ñ Analyzed by Claude Code (Headless Mode) | [Download Full Report](https://github.com/${REPO}/actions/runs/${{ github.run_id }})</sub>
          COMMENT_EOF

      - name: Post analysis comment
        uses: ./.github/actions/post-pr-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pr-number: ${{ github.event.pull_request.number }}
          comment-file: comment-body.md
          identifier: 'üîÑ GKE Version Upgrade Analysis'

      - name: Upload analysis report artifact
        uses: actions/upload-artifact@v4
        with:
          name: gke-analysis-report
          path: analysis-report.md
          retention-days: 30

  # validate-version:
  #   needs: detect-version-change
  #   if: needs.detect-version-change.outputs.has_changes == 'true'
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Setup gcloud CLI
  #       uses: google-github-actions/setup-gcloud@v2

  #     - name: Validate GKE version availability
  #       run: |
  #         chmod +x ./check-gke-version.sh

  #         if ./check-gke-version.sh; then
  #           echo "‚úÖ All versions are valid and available in GKE"
  #         else
  #           echo "‚ùå Version validation failed"
  #           echo "Please check the GKE release notes and update to a valid version"
  #           exit 1
  #         fi
